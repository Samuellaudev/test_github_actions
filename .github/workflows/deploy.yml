name: Deploy wp-content Folders

on:
  push:
    branches:
      - main

jobs:
  deploy-folders:
    name: üöÄ Deploy ${{ matrix.folder }}/
    runs-on: ubuntu-latest

    strategy:
      matrix:
        folder: [themes, plugins, mu-plugins]

    steps:
    - name: üßæ Checkout code
      uses: actions/checkout@v3

    - name: üîê Setup SSH Access
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

    - name: üõ†Ô∏è Ensure remote ${{ matrix.folder }}/ directory exists
      run: |
        if [ -d "wp-content/${{ matrix.folder }}" ]; then
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa \
          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
          "mkdir -p /home/${{ secrets.SSH_USER }}/staging.webdevspark.com/wp-content/${{ matrix.folder }}"
        else
          echo "‚ö†Ô∏è wp-content/${{ matrix.folder }} does not exist locally. Skipping remote mkdir."
        fi

    - name: üöÄ Deploy ${{ matrix.folder }}/ via rsync
      run: |
        if [ -d "wp-content/${{ matrix.folder }}" ]; then
          rsync -az --delete \
            wp-content/${{ matrix.folder }}/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/${{ secrets.SSH_USER }}/staging.webdevspark.com/wp-content/${{ matrix.folder }}/
        else
          echo "‚ö†Ô∏è wp-content/${{ matrix.folder }} does not exist locally. Skipping rsync."
        fi
