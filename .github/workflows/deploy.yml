name: Deploy wp-content Folders

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Perform a dry-run (preview only)?"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

jobs:
  deploy-folders:
    name: ğŸš€ Deploy ${{ matrix.folder }}/
    runs-on: ubuntu-latest

    strategy:
      matrix:
        folder: [themes, plugins, mu-plugins]

    steps:
    - name: ğŸ§¾ Checkout code
      uses: actions/checkout@v3

    - name: ğŸ” Setup SSH Access
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

    - name: ğŸ› ï¸ Ensure remote folder exists
      run: |
        if [ -d "wp-content/${{ matrix.folder }}" ]; then
          echo "âœ… Creating remote directory..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa \
          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
          "mkdir -p /home/${{ secrets.SSH_USER }}/staging.webdevspark.com/wp-content/${{ matrix.folder }}"
        else
          echo "âš ï¸ Local folder wp-content/${{ matrix.folder }} does not exist. Skipping remote mkdir."
        fi

    - name: ğŸš€ Deploy ${{ matrix.folder }}/ via rsync
      run: |
        if [ -d "wp-content/${{ matrix.folder }}" ]; then
          DRY_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            DRY_FLAG="--dry-run --itemize-changes"
            echo "ğŸ§ª DRY-RUN enabled â€” showing what would be deployed:"
          else
            echo "ğŸš€ LIVE DEPLOY â€” syncing files now."
          fi

          rsync -az --delete $DRY_FLAG \
            wp-content/${{ matrix.folder }}/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/${{ secrets.SSH_USER }}/staging.webdevspark.com/wp-content/${{ matrix.folder }}/
        else
          echo "âš ï¸ wp-content/${{ matrix.folder }} not found locally. Skipping rsync."
        fi
