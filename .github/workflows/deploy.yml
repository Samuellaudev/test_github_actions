name: Deploy wp-content Folders

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Perform a dry-run (preview only)?"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

jobs:
  deploy-folders:
    name: üöÄ Deploy ${{ matrix.folder }}/
    runs-on: ubuntu-latest

    strategy:
      matrix:
        folder: [themes, plugins, mu-plugins]

    steps:
    - name: üßæ Checkout code
      uses: actions/checkout@v3

    - name: üîê Setup SSH Access
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

    - name: üõ†Ô∏è Ensure remote folder exists
      run: |
        if [ -d "wp-content/${{ matrix.folder }}" ]; then
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa \
          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
          "mkdir -p /home/${{ secrets.SSH_USER }}/staging.webdevspark.com/wp-content/${{ matrix.folder }}"
        else
          echo "‚ö†Ô∏è wp-content/${{ matrix.folder }} does not exist locally. Skipping remote mkdir."
        fi

    - name: üöÄ Deploy ${{ matrix.folder }}/ via rsync
      run: |
        if [ -d "wp-content/${{ matrix.folder }}" ]; then
          DRY_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            DRY_FLAG="--dry-run --itemize-changes"
            echo "üß™ DRY-RUN enabled ‚Äî showing what would be deployed."
          else
            echo "üöÄ LIVE DEPLOY ‚Äî syncing files now."
          fi

          # Add --delete for folders you control
          DELETE_FLAG=""
          if [[ "${{ matrix.folder }}" != "plugins" ]]; then
            DELETE_FLAG="--delete"
          fi

          rsync -az $DRY_FLAG $DELETE_FLAG \
            wp-content/${{ matrix.folder }}/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/${{ secrets.SSH_USER }}/staging.webdevspark.com/wp-content/${{ matrix.folder }}/
        else
          echo "‚ö†Ô∏è wp-content/${{ matrix.folder }} not found locally. Skipping rsync."
        fi
